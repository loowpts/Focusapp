{% extends 'base.html' %}
{% load static %}
{% block extrahead %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
{% endblock %}

{% block content %}
  <h2>Мои задачи</h2>

  <!-- Календарь -->
  <div id="calendar" class="mb-5"></div>

  <!-- Кнопка создать -->
  <a href="{% url 'main:task_create' %}" class="btn btn-success mb-3">Создать задачу</a>

  <!-- Список задач -->
  <ul class="list-group">
    {% for task in tasks %}
      <li class="list-group-item d-flex justify-content-between align-items-center
                 {% if task.is_overdue %}list-group-item-danger{% endif %}">
        <div>
          <a href="{% url 'main:task_detail' task.pk %}">{{ task.title }}</a><br>
          <small class="text-muted">
            Срок:
            {% if task.deadline %}
            {{ task.deadline|date:"d.m.Y" }}
            {% else %}
            не указан
            {% endif %}
          </small>
          {% if task.is_overdue %}
            <span class="badge bg-danger ms-2">Просрочено</span>
          {% endif %}
        </div>

        <div class="d-flex gap-2 align-items-center flex-wrap">
          <span class="badge bg-{{ task.get_status_color }}">{{ task.get_status_display }}</span>
          <span class="badge bg-{{ task.get_priority_color }}">{{ task.get_priority_display }}</span>

          {% if task.status != 'done' %}
            <form method="post" action="{% url 'main:task_mark_done' task.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-success">Выполнить</button>
            </form>
          {% endif %}
        </div>
      </li>
    {% empty %}
      <li class="list-group-item">Нет задач</li>
    {% endfor %}
  </ul>
{% endblock %}

{% block extrascript %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ru',
      height: 500,
      events: [
        {% for task in tasks %}
          {% if task.due_date %}
            {
              title: "{{ task.title|escapejs }}",
              start: "{{ task.due_date|date:'Y-m-d' }}"  →  start: "{{ task.deadline|date:'Y-m-d' }}",
              url: "{% url 'main:task_detail' task.pk %}",
              color: "{% if task.status == 'done' %}#28a745{% elif task.is_overdue %}#dc3545{% elif task.priority == 'high' %}#fd7e14{% elif task.priority == 'medium' %}#ffc107{% else %}#17a2b8{% endif %}"
            },
          {% endif %}
        {% endfor %}
      ],
    });

    calendar.render();
  });
</script>
{% endblock %}
